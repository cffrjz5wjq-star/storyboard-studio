<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Storyboard Studio – Projekt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="styles.css" />

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <style>
    .hidden-col { display:none !important; }
    .row-selected { background:#fef3c7 !important; }
    tr.dragging { opacity:0.5; }
    tr.drag-over { outline:2px dashed #ff8a3c; }

    .hidden-file { display:none; }

    /* Bilder UI bleibt, aber Upload kommt später */
    .images-thumbs img {
      width:60px; height:auto;
      border-radius:4px;
      cursor:pointer;
      margin-right:4px;
    }
  </style>
</head>

<body>
<div class="app-shell">
  <div class="app project-app">

    <header class="project-header">
      <div class="header-left">
        <div class="logo-badge">SB</div>
        <div>
          <div class="header-title">Storyboard Studio</div>
          <div class="header-subtitle">Projekt bearbeiten</div>
        </div>
      </div>

      <div class="header-user">
        <span id="projectHeaderTitle"></span>
        <button onclick="window.location.href='index.html'" class="small secondary">Zurück</button>
      </div>
    </header>

    <main class="project-main">

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title" id="projTitle">Projekt</div>
            <div class="card-subtitle" id="projSubtitle"></div>
          </div>

          <div style="display:flex; gap:0.4rem;">
            <button id="btnDeleteProject" class="danger small">Projekt löschen</button>
            <button id="btnSaveProject" class="primary small">Projekt speichern</button>
          </div>
        </div>

        <div class="project-meta-grid">
          <div>
            <span class="project-meta-label">Projektname</span>
            <input id="peTitle" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Redaktion</span>
            <input id="peEditor" type="text" />
          </div>
          <div>
            <span class="project-meta-label">CVD</span>
            <input id="peCvd" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Bereich</span>
            <input id="peArea" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Sendung</span>
            <input id="peShow" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Format</span>
            <input id="peFormat" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Kurzbeschreibung</span>
            <input id="peShort" type="text" />
          </div>
          <div>
            <span class="project-meta-label">Projekt-ID</span>
            <input id="peId" type="text" disabled />
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Drehbuch &amp; Takes</div>
            <div class="card-subtitle">
              Takes, Sprechertexte und Timecodes bearbeiten. DOCX-Import möglich.
            </div>
          </div>

          <div class="toolbar-right">
            <button id="btnAddTake" class="small">+ neuer Take</button>
            <button id="btnDeleteSelected" class="small">Ausgewählte löschen</button>
            <button id="btnRecalcTc" class="small">Timecodes neu berechnen</button>
            <button id="btnExportPdf" class="small">Druck / PDF</button>
          </div>
        </div>

        <div class="toolbar">
          <div class="column-toggle-bar">
            <strong>Spalten:</strong>
            <label><input type="checkbox" data-col-toggle="take" checked disabled> Take</label>
            <label><input type="checkbox" data-col-toggle="tcIn" checked> In</label>
            <label><input type="checkbox" data-col-toggle="tcOut" checked> Out</label>
            <label><input type="checkbox" data-col-toggle="camera" checked> Bild/Kamera</label>
            <label><input type="checkbox" data-col-toggle="speaker" checked> Sprechertext</label>
            <label><input type="checkbox" data-col-toggle="persons" checked> Personen</label>
            <label><input type="checkbox" data-col-toggle="notes" checked> Notizen</label>
            <label><input type="checkbox" data-col-toggle="music" checked> Musik</label>
            <label><input type="checkbox" data-col-toggle="source" checked> Herkunft</label>
            <label><input type="checkbox" data-col-toggle="images" checked> Bilder</label>
          </div>

          <div style="font-size:0.78rem;">
            <label><input type="checkbox" id="chkAutoRenumber" checked> Take-Nummern automatisch</label>
            <label><input type="checkbox" id="chkAutoTc" checked> Timecodes automatisch</label>
          </div>
        </div>

        <div class="field">
          <label for="docxFile">DOCX-Datei (Word) importieren</label>
          <div style="display:flex; gap:0.4rem;">
            <input id="docxFile" type="file" accept=".docx" />
            <button id="btnImportDocx" class="small">DOCX importieren</button>
          </div>
          <div id="docxInfo" class="muted" style="margin-top:0.3rem;">
            Tabellen mit Takes werden erkannt.
          </div>
        </div>

        <div class="table-wrapper">
          <table class="takes-table" id="takesTable">
            <thead>
              <tr>
                <th data-col="take">Take</th>
                <th data-col="tcIn">In</th>
                <th data-col="tcOut">Out</th>
                <th data-col="camera">Bild/Kamera</th>
                <th data-col="speaker">Sprechertext</th>
                <th data-col="persons">Personen</th>
                <th data-col="notes">Notizen</th>
                <th data-col="music">Musik</th>
                <th data-col="source">Herkunft</th>
                <th data-col="images">Bilder</th>
              </tr>
            </thead>
            <tbody id="takesBody"></tbody>
          </table>
        </div>

        <div class="field" style="margin-top:0.6rem;">
          <label>Allgemeine Projekt-Notizen</label>
          <textarea id="projectNotes"></textarea>
        </div>

      </section>

    </main>
  </div>
</div>

<script>
"use strict";

const TC_FPS = 25;
let sb;
let projectId = null;
let currentProject = { id:null, title:"", takes:[] };

function $(id) { return document.getElementById(id); }

async function initSupabase() {
  const res = await fetch("/config", { cache: "no-store" });
  if (!res.ok) throw new Error("/config failed");
  const cfg = await res.json();
  sb = window.supabase.createClient(cfg.SUPABASE_URL, cfg.SUPABASE_ANON_KEY, {
    auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:"sb-auth" }
  });
}

function getProjectIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get("project_id");
}

async function requireSessionOrBack() {
  const { data } = await sb.auth.getSession();
  if (!data?.session) {
    alert("Bitte einloggen.");
    window.location.href = "index.html";
    return null;
  }
  return data.session;
}

function applyColumnVisibilityFromToggles() {
  const table = $("takesTable");
  if (!table) return;
  document.querySelectorAll("[data-col-toggle]").forEach(cb => {
    const col = cb.getAttribute("data-col-toggle");
    const visible = cb.checked;
    table.querySelectorAll(`[data-col="${col}"]`).forEach(cell => {
      cell.classList.toggle("hidden-col", !visible);
    });
  });
}

function estimateDurationSeconds(text) {
  if (!text) return 0;
  const words = text.trim().split(/\s+/).length;
  const wps = 3.0;
  return Math.ceil(words / wps);
}
function parseTimecode(tc) {
  if (!tc) return 0;
  const parts = tc.split(":").map(Number);
  while (parts.length < 4) parts.unshift(0);
  const [h,m,s,f] = parts;
  return (((h*60+m)*60)+s)*TC_FPS + f;
}
function formatTimecode(frames) {
  if (frames < 0) frames = 0;
  const f = frames % TC_FPS;
  let totalSeconds = (frames - f) / TC_FPS;
  const s = totalSeconds % 60;
  totalSeconds = (totalSeconds - s) / 60;
  const m = totalSeconds % 60;
  const h = (totalSeconds - m) / 60;
  const pad = n => String(n).padStart(2,"0");
  return `${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`;
}
function recalcTimecodes() {
  const takes = currentProject.takes || [];
  if (!takes.length) return;

  let cursor = 0;
  const firstIn = (takes[0].tcIn || "").trim();
  if (firstIn) cursor = parseTimecode(firstIn);

  takes.forEach(t => {
    const startFrames = cursor;
    t.tcIn = formatTimecode(startFrames);
    const durSec = estimateDurationSeconds(t.speaker || "");
    const endFrames = startFrames + durSec * TC_FPS;
    t.tcOut = formatTimecode(endFrames);
    cursor = endFrames;
  });
}

function renderTakesTable() {
  const tbody = $("takesBody");
  tbody.innerHTML = "";

  const takes = currentProject.takes || [];
  takes.forEach((t, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.index = idx;
    tr.draggable = true;

    tr.innerHTML = `
      <td data-col="take"><input type="text" data-field="take" data-index="${idx}" value="${t.take || (idx+1)}"></td>
      <td data-col="tcIn"><input type="text" data-field="tcIn" data-index="${idx}" value="${t.tcIn || ""}" placeholder="00:00:00:00"></td>
      <td data-col="tcOut"><input type="text" data-field="tcOut" data-index="${idx}" value="${t.tcOut || ""}" placeholder="00:00:00:00"></td>
      <td data-col="camera"><textarea data-field="camera" data-index="${idx}">${t.camera || ""}</textarea></td>
      <td data-col="speaker"><textarea data-field="speaker" data-index="${idx}">${t.speaker || ""}</textarea></td>
      <td data-col="persons"><textarea data-field="persons" data-index="${idx}">${t.persons || ""}</textarea></td>
      <td data-col="notes"><textarea data-field="notes" data-index="${idx}">${t.notes || ""}</textarea></td>
      <td data-col="music"><textarea data-field="music" data-index="${idx}">${t.music || ""}</textarea></td>
      <td data-col="source"><textarea data-field="source" data-index="${idx}">${t.source || ""}</textarea></td>
      <td data-col="images"><div class="images-cell"><div class="images-thumbs"></div><span class="muted">kommt gleich</span></div></td>
    `;

    tr.addEventListener("click", (e) => {
      if (["INPUT","TEXTAREA","LABEL"].includes(e.target.tagName)) return;
      tr.classList.toggle("row-selected");
    });

    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('input[data-field], textarea[data-field]').forEach(el => {
    el.addEventListener("input", () => {
      const index = parseInt(el.dataset.index, 10);
      const field = el.dataset.field;
      const take = currentProject.takes[index];
      if (!take) return;
      take[field] = el.value;

      const autoTc = $("chkAutoTc").checked;
      if (autoTc && (field === "speaker" || field === "tcIn")) {
        recalcTimecodes();
        // DOM Update der In/Out Felder ohne Neu-Render:
        currentProject.takes.forEach((tk, i) => {
          const row = tbody.querySelector(`tr[data-index="${i}"]`);
          if (!row) return;
          const inInput  = row.querySelector('input[data-field="tcIn"]');
          const outInput = row.querySelector('input[data-field="tcOut"]');
          if (inInput)  inInput.value  = tk.tcIn  || "";
          if (outInput) outInput.value = tk.tcOut || "";
        });
      }
    });
  });

  applyColumnVisibilityFromToggles();
}

function addEmptyTake() {
  const idx = currentProject.takes.length;
  currentProject.takes.push({
    take: String(idx+1),
    tcIn: "",
    tcOut: "",
    camera: "",
    speaker: "",
    persons: "",
    notes: "",
    music: "",
    source: ""
  });
  renderTakesTable();
}

function deleteSelectedTakes() {
  const tbody = $("takesBody");
  const rows = Array.from(tbody.querySelectorAll("tr.row-selected"));
  if (!rows.length) return alert("Keine Takes ausgewählt.");
  if (!confirm(`Wirklich ${rows.length} Take(s) löschen?`)) return;

  const indices = rows.map(r => parseInt(r.dataset.index,10)).sort((a,b)=>b-a);
  indices.forEach(i => currentProject.takes.splice(i,1));

  if ($("chkAutoRenumber").checked) {
    currentProject.takes.forEach((t, i) => t.take = String(i+1));
  }
  if ($("chkAutoTc").checked) recalcTimecodes();

  renderTakesTable();
}

async function loadFromSupabase() {
  projectId = getProjectIdFromUrl();
  if (!projectId) { alert("Projekt-ID fehlt."); window.location.href="index.html"; return; }

  await requireSessionOrBack();

  const { data: proj, error: pErr } = await sb
    .from("projects")
    .select("id,title,meta,created_at")
    .eq("id", projectId)
    .single();

  if (pErr || !proj) { alert("Projekt nicht gefunden."); window.location.href="index.html"; return; }

  const meta = proj.meta || {};
  $("peId").value = proj.id;
  $("peTitle").value = proj.title || "";
  $("peEditor").value = meta.editor || "";
  $("peCvd").value    = meta.cvd || "";
  $("peArea").value   = meta.area || "";
  $("peShow").value   = meta.show || "";
  $("peFormat").value = meta.format || "";
  $("peShort").value  = meta.short || "";
  $("projectNotes").value = meta.notes || "";

  $("projTitle").textContent = proj.title || "Projekt";
  $("projectHeaderTitle").textContent = proj.title || "";

  const metaParts = [];
  if (meta.show) metaParts.push(meta.show);
  if (meta.format) metaParts.push(meta.format);
  $("projSubtitle").textContent = metaParts.join(" · ");

  const { data: rows, error: tErr } = await sb
    .from("takes")
    .select("*")
    .eq("project_id", projectId)
    .order("take_no", { ascending: true });

  if (tErr) { alert(tErr.message); return; }

  currentProject = {
    id: proj.id,
    title: proj.title,
    takes: (rows || []).map(r => ({
      take: String(r.take_no ?? ""),
      tcIn: r.tc_in || "",
      tcOut: r.tc_out || "",
      camera: r.bild_kamera || "",
      speaker: r.sprechertext || "",
      persons: r.personen || "",
      notes: r.notizen || "",
      music: r.musik || "",
      source: r.herkunft || ""
    }))
  };

  renderTakesTable();
}

async function saveToSupabase() {
  if (!projectId) return;

  await requireSessionOrBack();

  const title = $("peTitle").value.trim() || "Unbenannt";
  const meta = {
    editor: $("peEditor").value.trim(),
    cvd: $("peCvd").value.trim(),
    area: $("peArea").value.trim(),
    show: $("peShow").value.trim(),
    format: $("peFormat").value.trim(),
    short: $("peShort").value.trim(),
    notes: $("projectNotes").value || ""
  };

  const { error: pErr } = await sb
    .from("projects")
    .update({ title, meta })
    .eq("id", projectId);

  if (pErr) return alert(pErr.message);

  await sb.from("takes").delete().eq("project_id", projectId);

  const rows = (currentProject.takes || []).map((t, i) => ({
    project_id: projectId,
    take_no: parseInt(t.take || String(i+1), 10),
    tc_in: t.tcIn || "",
    tc_out: t.tcOut || "",
    bild_kamera: t.camera || "",
    sprechertext: t.speaker || "",
    personen: t.persons || "",
    notizen: t.notes || "",
    musik: t.music || "",
    herkunft: t.source || ""
  }));

  if (rows.length) {
    const { error: tErr } = await sb.from("takes").insert(rows);
    if (tErr) return alert(tErr.message);
  }

  alert("Projekt gespeichert (online).");
}

async function deleteProject() {
  if (!projectId) return;
  if (!confirm("Projekt wirklich löschen?")) return;

  await requireSessionOrBack();

  await sb.from("takes").delete().eq("project_id", projectId);
  const { error } = await sb.from("projects").delete().eq("id", projectId);
  if (error) return alert(error.message);

  alert("Projekt gelöscht.");
  window.location.href = "index.html";
}

// DOCX Import: nutzt deine alte Logik, mapt in currentProject.takes
function parseDocxHtmlToTakes(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  const tables = Array.from(doc.querySelectorAll("table"));
  const takes = [];

  if (tables.length) {
    tables.forEach((table) => {
      const rows = Array.from(table.rows || table.querySelectorAll("tr"));
      if (!rows.length) return;

      let sceneTitle = "";
      const firstCellText = (rows[0].cells[0] && rows[0].cells[0].textContent || "").trim();
      if (/TITEL:/i.test(firstCellText)) sceneTitle = firstCellText.replace(/TITEL:\s*/i, "").trim();

      for (let ri = 1; ri < rows.length; ri++) {
        const row = rows[ri];
        if (!row.cells || row.cells.length < 2) continue;

        const left  = (row.cells[0].textContent || "").trim();
        const right = (row.cells[1].textContent || "").trim();
        if (!left && !right) continue;

        const combined = (left + " " + right).toLowerCase();
        if (combined.match(/beschreibung|idee|sprechertext/)) continue;

        takes.push({
          take: String(takes.length + 1),
          tcIn: "",
          tcOut: "",
          camera: left,
          speaker: right,
          persons: "",
          notes: sceneTitle || "",
          music: "",
          source: ""
        });
      }
    });
    return takes;
  }

  const paras = doc.querySelectorAll("p");
  paras.forEach(p => {
    const text = p.textContent.trim();
    if (!text) return;
    takes.push({
      take: String(takes.length + 1),
      tcIn: "",
      tcOut: "",
      camera: "",
      speaker: text,
      persons: "",
      notes: "",
      music: "",
      source: ""
    });
  });
  return takes;
}

function handleDocxImport() {
  const file = $("docxFile").files && $("docxFile").files[0];
  if (!file) { $("docxInfo").textContent = "Bitte zuerst eine DOCX-Datei auswählen."; return; }

  $("docxInfo").textContent = "DOCX wird verarbeitet …";

  const reader = new FileReader();
  reader.onload = (e) => {
    const arrayBuffer = e.target.result;
    mammoth.convertToHtml({ arrayBuffer }).then(result => {
      const html = result.value || "";
      const imported = parseDocxHtmlToTakes(html);
      if (!imported.length) { $("docxInfo").textContent = "Nichts gefunden."; return; }

      currentProject.takes = (currentProject.takes || []).concat(imported);

      if ($("chkAutoRenumber").checked) currentProject.takes.forEach((t, i) => t.take = String(i + 1));
      if ($("chkAutoTc").checked) recalcTimecodes();

      renderTakesTable();
      $("docxInfo").textContent = `${imported.length} Takes importiert.`;
    }).catch(() => {
      $("docxInfo").textContent = "Fehler beim Lesen der DOCX-Datei.";
    });
  };
  reader.readAsArrayBuffer(file);
}

function setupEvents() {
  $("btnSaveProject").addEventListener("click", saveToSupabase);
  $("btnAddTake").addEventListener("click", addEmptyTake);
  $("btnDeleteSelected").addEventListener("click", deleteSelectedTakes);
  $("btnRecalcTc").addEventListener("click", () => { recalcTimecodes(); renderTakesTable(); });
  $("btnExportPdf").addEventListener("click", exportCurrentViewToPdf);
  $("btnImportDocx").addEventListener("click", handleDocxImport);
  $("btnDeleteProject").addEventListener("click", deleteProject);

  document.querySelectorAll("[data-col-toggle]").forEach(cb => cb.addEventListener("change", applyColumnVisibilityFromToggles));
}

function exportCurrentViewToPdf() {
  // identisch zu deiner bisherigen PDF-Funktion (gekürzt: nutzt currentProject)
  const toggles = document.querySelectorAll("[data-col-toggle]");
  const visibleCols = Array.from(toggles).filter(t => t.checked).map(t => t.getAttribute("data-col-toggle"));

  const labels = {
    take: "Take", tcIn:"In", tcOut:"Out", camera:"Bild/Kamera", speaker:"Sprechertext",
    persons:"Personen", notes:"Notizen", music:"Musik", source:"Herkunft", images:"Bilder"
  };

  const p = { title: $("peTitle").value || "Storyboard", notes: $("projectNotes").value || "" };
  const takes = currentProject.takes || [];

  const head = visibleCols.map(c => `<th>${labels[c] || c}</th>`).join("");
  const rows = takes.map(t => {
    const tds = visibleCols.map(c => {
      if (c === "images") return `<td></td>`;
      let v = "";
      if (c === "take") v = t.take || "";
      else if (c === "tcIn") v = t.tcIn || "";
      else if (c === "tcOut") v = t.tcOut || "";
      else v = t[c] || "";
      v = String(v).replace(/</g, "&lt;").replace(/\r?\n/g, "<br>");
      return `<td>${v}</td>`;
    }).join("");
    return `<tr>${tds}</tr>`;
  }).join("");

  const tableHtml = `<table><thead><tr>${head}</tr></thead><tbody>${rows}</tbody></table>`;
  const w = window.open("", "_blank");
  const title = p.title;

  w.document.write(`
    <!DOCTYPE html><html lang="de"><head><meta charset="UTF-8">
    <title>${title}</title>
    <style>
      body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;font-size:11px;margin:20px;color:#111827;}
      h1{font-size:18px;margin-bottom:4px;}
      table{border-collapse:collapse;width:100%;font-size:10px;}
      th,td{border:1px solid #9ca3af;padding:3px 4px;vertical-align:top;}
      th{background:#e5e7eb;}
      .notes{font-size:10px;margin-top:8px;white-space:pre-wrap;}
    </style></head><body>
      <h1>${title}</h1>
      <h2>Takes</h2>
      ${tableHtml}
      ${p.notes ? `<div class="notes"><strong>Projekt-Notizen:</strong><br>${String(p.notes).replace(/</g,"&lt;").replace(/\r?\n/g,"<br>")}</div>` : ""}
    </body></html>
  `);
  w.document.close();
  w.focus();
  w.print();
}

document.addEventListener("DOMContentLoaded", async () => {
  try {
    await initSupabase();
    setupEvents();
    await loadFromSupabase();
  } catch (e) {
    console.error(e);
    alert(String(e.message || e));
    window.location.href = "index.html";
  }
});
</script>

</body>
</html>
